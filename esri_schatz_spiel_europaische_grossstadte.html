<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sch√§tz-Spiel: Europ√§ische Gro√üst√§dte (Esri)</title>
  <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css" />
  <script src="https://js.arcgis.com/4.29/"></script>
  <style>
    html, body, #viewDiv { height: 100%; width: 100%; margin: 0; padding: 0; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }

    .hud { position: absolute; top: 12px; left: 12px; display: grid; gap: 8px; z-index: 10; width: min(360px, 92vw); }
    .card { background: rgba(255,255,255,0.9); backdrop-filter: blur(6px); border-radius: 14px; box-shadow: 0 6px 20px rgba(0,0,0,0.15); padding: 12px 14px; }
    .row { display: flex; align-items: center; gap: 10px; }
    .title { font-size: 16px; font-weight: 700; }
    .subtle { color: #4b5563; font-size: 12px; }
    .btn { appearance: none; border: 0; border-radius: 10px; padding: 8px 10px; font-weight: 700; cursor: pointer; box-shadow: 0 2px 10px rgba(0,0,0,0.12); font-size: 13px; }
    .btn-primary { background: #2563eb; color: white; }
    .btn-secondary { background: #e5e7eb; color: #111827; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .dialog { position: absolute; right: 12px; top: 12px; min-width: 220px; max-width: 280px; }
    .meter { height: 8px; background: #e5e7eb; border-radius: 8px; overflow: hidden; }
    .meter > div { height: 100%; width: 0%; background: #10b981; transition: width 300ms ease; }

    .toast { position: absolute; bottom: 16px; left: 50%; transform: translateX(-50%); background: rgba(17,24,39,0.9); color: #fff; padding: 10px 12px; border-radius: 10px; font-size: 13px; display: none; }

    .legend { position: absolute; bottom: 14px; right: 14px; background: rgba(255,255,255,0.9); backdrop-filter: blur(6px); padding: 8px 10px; border-radius: 10px; font-size: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.15); }

    /* Kompakte Ergebnisliste oben links als Karte unter der Aufgabenkarte */
    .results-card { padding: 8px 10px; }
    .results-header { display: flex; justify-content: space-between; align-items: center; font-weight: 700; font-size: 13px; cursor: pointer; }
    .results-body { margin-top: 6px; display: none; }
    .results-body.open { display: block; }
    .results { max-height: 140px; overflow-y: auto; }
    .results table { width: 100%; border-collapse: collapse; font-size: 12px; }
    .results th, .results td { padding: 2px 4px; text-align: left; white-space: nowrap; }
    .results th { position: sticky; top: 0; background: #f3f4f6; z-index: 1; }
    .results tr:nth-child(even) { background: rgba(0,0,0,0.04); }
  </style>
</head>
<body>
  <div id="viewDiv"></div>

  <!-- HUD oben links -->
  <div class="hud">
    <!-- Aufgabenkarte -->
    <div class="card">
      <div class="title">üåÜ Finde die Stadt: <span id="cityName">‚Äî</span></div>
      <div class="subtle">Aufgabe <span id="round">0</span> / <span id="total">10</span> ‚Ä¢ Klicke auf die Karte, um deine Sch√§tzung zu setzen. Zoomen &amp; Schwenken ist frei.</div>
      <div class="row" style="margin-top:8px; gap:6px; flex-wrap: wrap;">
        <button id="checkBtn" class="btn btn-primary" disabled>Sch√§tzung pr√ºfen</button>
        <button id="skipBtn" class="btn btn-secondary">√úberspringen</button>
        <button id="resetBtn" class="btn btn-secondary">Neu starten</button>
      </div>
    </div>

    <!-- Kompakte Ergebnisliste direkt darunter -->
    <div class="card results-card">
      <div id="resultsHeader" class="results-header">Ergebnisliste <span id="toggleArrow">‚ñ∫</span></div>
      <div id="resultsBodyWrap" class="results-body">
        <div class="results">
          <table>
            <thead><tr><th>#</th><th>Stadt</th><th>km</th></tr></thead>
            <tbody id="resultsBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Rechte Box: Gesamtabweichung -->
  <div class="card dialog">
    <div class="title">üìè Summe der Abweichungen</div>
    <div class="row" style="justify-content: space-between; margin-top:6px;">
      <div>
        <div id="sumKm" style="font-size:22px; font-weight:800;">0 km</div>
        <div class="subtle">(niedriger ist besser)</div>
      </div>
      <div style="width: 90px; align-self: center;">
        <div class="meter"><div id="meterFill"></div></div>
        <div class="subtle" style="text-align:right; margin-top:4px;">Fortschritt</div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>
  <div class="legend">Basemap: Esri World Imagery (ohne Labels)</div>

<script>
require(["esri/Map","esri/views/MapView","esri/Graphic","esri/geometry/Point","esri/layers/GraphicsLayer"],
(Map, MapView, Graphic, Point, GraphicsLayer) => {

  // Stark erweiterter Pool europ√§ischer Gro√üst√§dte (>500k Einwohner; N√§herungswerte)
  const CITIES = [
    // Westeuropa
    { name: "London", lat: 51.5074, lon: -0.1278 },
    { name: "Birmingham", lat: 52.4862, lon: -1.8904 },
    { name: "Leeds", lat: 53.8008, lon: -1.5491 },
    { name: "Manchester", lat: 53.4808, lon: -2.2426 },
    { name: "Sheffield", lat: 53.3811, lon: -1.4701 },
    { name: "Glasgow", lat: 55.8642, lon: -4.2518 },
    { name: "Edinburgh", lat: 55.9533, lon: -3.1883 },
    { name: "Dublin", lat: 53.3498, lon: -6.2603 },
    { name: "Paris", lat: 48.8566, lon: 2.3522 },
    { name: "Marseille", lat: 43.2965, lon: 5.3698 },
    { name: "Lyon", lat: 45.7640, lon: 4.8357 },

    // Benelux
    { name: "Amsterdam", lat: 52.3676, lon: 4.9041 },
    { name: "Rotterdam", lat: 51.9244, lon: 4.4777 },
    { name: "Den Haag", lat: 52.0705, lon: 4.3007 },
    { name: "Antwerpen", lat: 51.2194, lon: 4.4025 },

    // Deutschland
    { name: "Berlin", lat: 52.5200, lon: 13.4050 },
    { name: "Hamburg", lat: 53.5511, lon: 9.9937 },
    { name: "M√ºnchen", lat: 48.1351, lon: 11.5820 },
    { name: "K√∂ln", lat: 50.9375, lon: 6.9603 },
    { name: "Frankfurt am Main", lat: 50.1109, lon: 8.6821 },
    { name: "Stuttgart", lat: 48.7758, lon: 9.1829 },
    { name: "D√ºsseldorf", lat: 51.2277, lon: 6.7735 },
    { name: "Dortmund", lat: 51.5136, lon: 7.4653 },
    { name: "Essen", lat: 51.4556, lon: 7.0116 },
    { name: "Bremen", lat: 53.0793, lon: 8.8017 },
    { name: "Leipzig", lat: 51.3397, lon: 12.3731 },
    { name: "Dresden", lat: 51.0504, lon: 13.7373 },
    { name: "Hannover", lat: 52.3759, lon: 9.7320 },
    { name: "N√ºrnberg", lat: 49.4521, lon: 11.0767 },
    { name: "Duisburg", lat: 51.4344, lon: 6.7623 },

    // Iberische Halbinsel
    { name: "Madrid", lat: 40.4168, lon: -3.7038 },
    { name: "Barcelona", lat: 41.3851, lon: 2.1734 },
    { name: "Valencia", lat: 39.4699, lon: -0.3763 },
    { name: "Sevilla", lat: 37.3891, lon: -5.9845 },
    { name: "Zaragoza", lat: 41.6488, lon: -0.8891 },
    { name: "M√°laga", lat: 36.7213, lon: -4.4213 },
    { name: "Lissabon", lat: 38.7223, lon: -9.1393 },

    // Italien
    { name: "Rom", lat: 41.9028, lon: 12.4964 },
    { name: "Mailand", lat: 45.4642, lon: 9.1900 },
    { name: "Neapel", lat: 40.8518, lon: 14.2681 },
    { name: "Turin", lat: 45.0703, lon: 7.6869 },
    { name: "Palermo", lat: 38.1157, lon: 13.3615 },
    { name: "Genua", lat: 44.4056, lon: 8.9463 },

    // Mitteleuropa
    { name: "Wien", lat: 48.2082, lon: 16.3738 },
    { name: "Prag", lat: 50.0755, lon: 14.4378 },
    { name: "Budapest", lat: 47.4979, lon: 19.0402 },
    { name: "Warschau", lat: 52.2297, lon: 21.0122 },
    { name: "Krakau", lat: 50.0647, lon: 19.9450 },
    { name: "≈Å√≥d≈∫", lat: 51.7592, lon: 19.4550 },
    { name: "Breslau", lat: 51.1079, lon: 17.0385 },
    { name: "Posen", lat: 52.4064, lon: 16.9252 },

    // Nordeuropa
    { name: "Kopenhagen", lat: 55.6761, lon: 12.5683 },
    { name: "Oslo", lat: 59.9139, lon: 10.7522 },
    { name: "Stockholm", lat: 59.3293, lon: 18.0686 },
    { name: "G√∂teborg", lat: 57.7089, lon: 11.9746 },
    { name: "Helsinki", lat: 60.1699, lon: 24.9384 },

    // S√ºdosteuropa & Balkan
    { name: "Athen", lat: 37.9838, lon: 23.7275 },
    { name: "Bukarest", lat: 44.4268, lon: 26.1025 },
    { name: "Sofia", lat: 42.6977, lon: 23.3219 },
    { name: "Belgrad", lat: 44.8125, lon: 20.4612 },
    { name: "Zagreb", lat: 45.8150, lon: 15.9819 },
    { name: "Skopje", lat: 41.9981, lon: 21.4254 },

    // Baltikum & Osteuropa
    { name: "Vilnius", lat: 54.6872, lon: 25.2797 },
    { name: "Riga", lat: 56.9496, lon: 24.1052 },
    { name: "Minsk", lat: 53.9006, lon: 27.5590 },
    { name: "Kyjiw", lat: 50.4501, lon: 30.5234 },
    { name: "Charkiw", lat: 49.9935, lon: 36.2304 },
    { name: "Dnipro", lat: 48.4647, lon: 35.0462 },
    { name: "Odessa", lat: 46.4825, lon: 30.7233 },
    { name: "Saporischschja", lat: 47.8388, lon: 35.1396 },
    { name: "Lwiw", lat: 49.8397, lon: 24.0297 },
    { name: "Chisinau", lat: 47.0105, lon: 28.8638 },

    // Europ√§isches Russland
    { name: "Moskau", lat: 55.7558, lon: 37.6173 },
    { name: "Sankt Petersburg", lat: 59.9311, lon: 30.3609 },
    { name: "Kasan", lat: 55.7963, lon: 49.1088 },
    { name: "Nischni Nowgorod", lat: 56.2965, lon: 43.9361 },
    { name: "Samara", lat: 53.1959, lon: 50.1000 },
    { name: "Ufa", lat: 54.7388, lon: 55.9721 },
    { name: "Perm", lat: 58.0105, lon: 56.2502 },
    { name: "Wolgograd", lat: 48.7080, lon: 44.5133 },
    { name: "Rostow am Don", lat: 47.2357, lon: 39.7015 },
    { name: "Woronesch", lat: 51.6615, lon: 39.2003 },

    // T√ºrkei (europ√§ischer Teil)
    { name: "Istanbul", lat: 41.0082, lon: 28.9784 }
  ];

  const TOTAL_ROUNDS = 10;
  let selectedCities = [];
  let currentIndex = -1;
  let totalDistanceKm = 0;
  let currentGuessGraphic = null;
  let solutionGraphic = null;
  let lineGraphic = null;

  const map = new Map({ basemap: "satellite" });
  const view = new MapView({ container: "viewDiv", map, center: [10, 51], zoom: 4, constraints: { minZoom: 1, maxZoom: 22, rotationEnabled: false } });

  view.when(() => { const refLayers = view.map.basemap.referenceLayers; if (refLayers && refLayers.length) refLayers.forEach(lyr => lyr.visible = false); });

  const graphicsLayer = new GraphicsLayer();
  map.add(graphicsLayer);

  const cityNameEl = document.getElementById('cityName');
  const roundEl = document.getElementById('round');
  const totalEl = document.getElementById('total');
  const checkBtn = document.getElementById('checkBtn');
  const skipBtn = document.getElementById('skipBtn');
  const resetBtn = document.getElementById('resetBtn');
  const sumKmEl = document.getElementById('sumKm');
  const meterFill = document.getElementById('meterFill');
  const toast = document.getElementById('toast');
  const resultsBody = document.getElementById('resultsBody');
  const resultsHeader = document.getElementById('resultsHeader');
  const resultsBodyWrap = document.getElementById('resultsBodyWrap');
  const toggleArrow = document.getElementById('toggleArrow');

  totalEl.textContent = TOTAL_ROUNDS;

  function showToast(msg) { toast.textContent = msg; toast.style.display = 'block'; setTimeout(() => toast.style.display = 'none', 1600); }
  function shuffle(arr) { return arr.map(v => ({ v, r: Math.random() })).sort((a,b) => a.r - b.r).map(o => o.v); }

  function startGame() {
    selectedCities = shuffle(CITIES).slice(0, TOTAL_ROUNDS);
    currentIndex = -1; totalDistanceKm = 0; sumKmEl.textContent = '0 km'; meterFill.style.width = '0%';
    resultsBody.innerHTML = '';
    // Ergebnisliste beim Start einklappen
    resultsBodyWrap.classList.remove('open'); toggleArrow.textContent = '‚ñ∫';
    nextRound();
  }

  function nextRound() {
    graphicsLayer.removeAll(); currentGuessGraphic = null; solutionGraphic = null; lineGraphic = null; checkBtn.disabled = true;
    currentIndex++; roundEl.textContent = Math.min(currentIndex + 1, TOTAL_ROUNDS);
    if (currentIndex >= TOTAL_ROUNDS) { cityNameEl.textContent = 'Fertig!'; showToast(`Spiel beendet ‚Äì Gesamt: ${totalDistanceKm.toFixed(1)} km`); return; }
    const city = selectedCities[currentIndex]; cityNameEl.textContent = city.name;
    if (currentIndex === 0) view.goTo({ center: [10, 51], zoom: 4 }, { animate: true, duration: 1000 });
  }

  view.on("click", (event) => {
    const p = event.mapPoint; if (!p) return;
    const guess = new Graphic({ geometry: p, symbol: { type: "simple-marker", style: "circle", size: 11, color: [37, 99, 235, 0.95], outline: { color: [255,255,255,1], width: 1 } } });
    if (currentGuessGraphic) graphicsLayer.remove(currentGuessGraphic);
    currentGuessGraphic = guess; graphicsLayer.add(guess); checkBtn.disabled = false;
  });

  function computeDistanceKm(a, b) {
    const R = 6371; const toRad = d => d * Math.PI / 180;
    const dLat = toRad(b.latitude - a.latitude); const dLon = toRad(b.longitude - a.longitude);
    const lat1 = toRad(a.latitude); const lat2 = toRad(b.latitude);
    const h = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
    return 2 * R * Math.asin(Math.min(1, Math.sqrt(h)));
  }

  function drawSolutionAndScore() {
    const city = selectedCities[currentIndex]; if (!city || !currentGuessGraphic) return;
    const target = new Point({ longitude: city.lon, latitude: city.lat, spatialReference: { wkid: 4326 } });
    const solutionGraphic = new Graphic({ geometry: target, symbol: { type: "simple-marker", style: "diamond", size: 11, color: [239, 68, 68, 0.95], outline: { color: [255,255,255,1], width: 1 } } });
    const lineGraphic = new Graphic({ geometry: { type: "polyline", paths: [ [currentGuessGraphic.geometry.longitude, currentGuessGraphic.geometry.latitude], [city.lon, city.lat] ], spatialReference: { wkid: 4326 } }, symbol: { type: "simple-line", width: 2, color: [16, 185, 129, 0.9] } });
    graphicsLayer.addMany([solutionGraphic, lineGraphic]);

    const dist = computeDistanceKm(currentGuessGraphic.geometry, target);
    totalDistanceKm += dist; sumKmEl.textContent = `${totalDistanceKm.toFixed(1)} km`;
    const progress = ((currentIndex + 1) / TOTAL_ROUNDS) * 100; meterFill.style.width = `${progress}%`;
    showToast(`Abweichung: ${dist.toFixed(1)} km`);

    const row = document.createElement('tr');
    row.innerHTML = `<td>${currentIndex+1}</td><td>${city.name}</td><td>${dist.toFixed(1)}</td>`;
    resultsBody.appendChild(row);

    setTimeout(() => nextRound(), 800);
  }

  document.getElementById('checkBtn').addEventListener('click', drawSolutionAndScore);
  document.getElementById('skipBtn').addEventListener('click', () => { if (!currentGuessGraphic) { showToast('√úbersprungen.'); nextRound(); } else { drawSolutionAndScore(); } });
  document.getElementById('resetBtn').addEventListener('click', startGame);

  resultsHeader.addEventListener('click', () => {
    const isOpen = resultsBodyWrap.classList.toggle('open');
    toggleArrow.textContent = isOpen ? '‚ñº' : '‚ñ∫';
  });

  startGame();
});
</script>

</body>
</html>